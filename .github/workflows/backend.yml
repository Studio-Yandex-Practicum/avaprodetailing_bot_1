name: ava_pro_detealing_test_backend
on: 
    push:
        branches:
            - development
            - 'feature/CI_CD'
env:
    BACKEND_IMAGE: ${{ secrets.DOCKER_USERNAME_TEST }}/ava_pro_detealing:latest
jobs:

    build_and_push_to_hub:
        name: Push container to Docker Hub
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repo
              uses: docker/checkout@v4

            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                username: ${{ secrets.DOCKER_USERNAME_TEST }}
                password: ${{ secrets.DOCKER_PASSWORD_TEST }}

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Push backend to Docker Hub
              uses: docker/build-push-action@v5
              with:
                push: true
                file: ./app.Dockerfile
                tags: ${{ env.BACKEND_IMAGE }}

    deploy:
        runs-on: ubuntu-latest
        needs: build_and_push_to_hub
        steps:
            - name: executing remote ssh commands to deploy
              uses: appleboy/ssh-action@master
              with:                
                host: ${{ secrets.HOST }}
                username: ${{ secrets.USER }}
                key: ${{ secrets.SSH_KEY }}
                passphrase: ${{ secrets.PASSPHRASE }}
                script: |
                    cd ~/avaprodetailing_test
                    sudo docker compose stop
                    sudo docker pull ${{ env.BACKEND_IMAGE }}
                    sudo docker compose up -d
                    sudo docker image prune -f