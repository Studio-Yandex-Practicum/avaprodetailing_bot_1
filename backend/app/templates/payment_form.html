{% extends 'base.html' %}
{% block title %}Создание платежа{% endblock title %}
{% block content %}
<div class="container">
    <div class="row align-items-center justify-content-center">
        <div class="col-md-6">
            <h1 class="text-center">Новый платеж</h1>
            <form id="add_payment" class="form-control">
                <div class="mb-3">
                    <label for="price" class="form-label">Сумма платежа</label>
                    <input type="number" name="price" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="payment_method" class="form-label">Способ оплаты</label>
                    <select name="payment_method" class="form-control" required>
                        <option value="online">Онлайн</option>
                        <option value="cash">Наличными</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="payer_id" class="form-label">Идентификатор плательщика </label>
                    <input type="text" name="payer_id" class="form-control" required>
                    <button type="button" id="scan_qr_button" style="background-color: transparent; border: none; margin-top: 10px;">
                        <img src="/static/img/scanner.png" width="40" height="40" style="filter: invert(100%);">
                        <span style="margin-left: 5px; color: white;">Сканировать карту лояльности</span>
                    </button>
                </div>
                <div class="mb-3">
                    <input type="hidden" name="admin_id" value="{{ admin_telegram_id }}">
                </div>
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <input type="button" id="add_payment_button" value="Создать">
                </div>
            </form>
            <script>
                $(document).ready(function(){
                    $('#scan_qr_button').on('click', function(){
                        Telegram.WebApp.showScanQrPopup({
                            text: 'with any link'
                        }, function (text) {
                            $('input[name="payer_id"]').val(text);
                            return true;
                        });
                    });
                });
            </script>
            <script>
                $(document).ready(function(){
                    Telegram.WebApp.ready()
                    var WebApp = window.Telegram.WebApp
                    WebApp.expand()
                    $('#add_payment_button').on('click', function(event){
                        event.preventDefault()
                        $.ajax({
                            url: '/payments/admin/{{ admin_telegram_id }}/create_payment',
                            method: 'post',
                            dataType: 'json',
                            contentType: 'application/json',
                            data: JSON.stringify(
                                {
                                    price: $('input[name="price"]').val(),
                                    payment_method: $('select[name="payment_method"]').val(),
                                    payer_id: $('input[name="payer_id"]').val(),
                                    admin_id: '{{ admin_telegram_id }}'
                                }
                            ),
                            statusCode: {
                                200: function () {
                                    alert('Платеж создан')
                                    WebApp.close();
                                }
                            }
                        })
                    })
                })
            </script>
        </div>
    </div>
</div>
{% endblock content %}
